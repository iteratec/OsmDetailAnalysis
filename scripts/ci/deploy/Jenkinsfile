#!groovy

node ('master'){

  try{

    stage('SCM'){

        checkout([
            $class: 'GitSCM',
            branches: [[name: '*/develop']],
            doGenerateSubmoduleConfigurations: false,
            extensions: [],
            submoduleCfg: [],
            userRemoteConfigs: [[url: 'https://github.com/iteratec/OsmDetailAnalysis.git']]
        ])

    }

    stage('Copy compose file to host'){
        sh 'pwd'
        sh 'ls -la'
        sh './scripts/ci/deploy/copy_compose_file_to_host.sh'
    }

    stage('prepare env file for compose on host'){

        sh './scripts/ci/deploy/prepare_compose_env_file.sh'

    }


  } catch(e) {

    currentBuild.result = "FAILED"
    //notifyFailed()
    throw e

  }

}

def notifyFailed() {
  def subject = "${currentBuild.result}: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]'"
  def body = """<p>STARTED: Job '${env.JOB_NAME} [${env.BUILD_NUMBER}]':</p>
  <p>Check console output at &QUOT;<a href='${env.BUILD_URL}'>${env.JOB_NAME} [${env.BUILD_NUMBER}]</a>&QUOT;</p>"""

  mail(
   body: body,
   subject: subject,
   to: 'nils.kuhn@iteratec.de'
  )
}
